{"ast":null,"code":"var _jsxFileName = \"/home/goik4/\\u0423\\u043D\\u0438\\u0432\\u0435\\u0440/corsework/Voice-Roulete-Coursework/Voice-Roulete-Coursework/roulete/client/src/routes/MainPage/MainPage.tsx\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState } from 'react';\nimport io from 'socket.io-client';\nimport Cookies from 'js-cookie';\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst socket = io('http://localhost:5000', {\n  transports: ['websocket']\n});\nconst configuration = {\n  iceServers: [{\n    urls: 'stun:stun.l.google.com:19302'\n  }]\n};\nconst MainPage = () => {\n  _s();\n  const [localStream, setLocalStream] = useState(null);\n  const peerConnectionRef = useRef(null);\n  useEffect(() => {\n    return () => {\n      localStream === null || localStream === void 0 ? void 0 : localStream.getTracks().forEach(track => track.stop());\n      socket.off('offer');\n      socket.off('answer');\n      socket.off('candidate');\n      if (peerConnectionRef.current) {\n        peerConnectionRef.current.close();\n      }\n    };\n  }, [localStream]);\n  const getUserId = () => {\n    const userId = Cookies.get('userIdState');\n    if (!userId) {\n      alert('Сначала войдите в аккаунт');\n      return;\n    }\n    socket.emit('auth', userId);\n    getMedia(userId);\n  };\n  const getMedia = async userId => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: true,\n        video: false\n      });\n      setLocalStream(stream);\n      startCall(stream, userId);\n    } catch (err) {\n      console.error('Не удалось получить доступ к микрофону', err);\n    }\n  };\n  const startCall = (stream, userId) => {\n    // Создаем подключение\n    const peerConnection = new RTCPeerConnection(configuration);\n    peerConnectionRef.current = peerConnection;\n    // Добавляем треки\n    stream.getTracks().forEach(track => {\n      peerConnection.addTrack(track, stream);\n    });\n\n    // Слушаем кандидатов ICE\n    peerConnection.onicecandidate = event => {\n      if (event.candidate) {\n        console.log(event.candidate);\n        socket.emit('candidate', {\n          candidate: event.candidate,\n          target: userId\n        });\n      }\n    };\n\n    // Создаем предложение (offer)\n    peerConnection.createOffer().then(offer => peerConnection.setLocalDescription(offer)).then(() => {\n      // Отправляем предложение через сокет\n      socket.emit('offer', {\n        sdp: peerConnection.localDescription,\n        target: userId\n      });\n    }).catch(err => console.error(err));\n  };\n\n  // Устанавливаем обработчики событий сокета\n  useEffect(() => {\n    socket.on('offer', data => {\n      if (!peerConnectionRef.current && localStream) {\n        const peerConnection = new RTCPeerConnection(configuration);\n        peerConnectionRef.current = peerConnection;\n        localStream.getTracks().forEach(track => {\n          peerConnection.addTrack(track, localStream);\n        });\n        peerConnection.onicecandidate = event => {\n          if (event.candidate) {\n            socket.emit('candidate', {\n              candidate: event.candidate,\n              target: data.sender\n            });\n          }\n        };\n        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp)).then(() => peerConnection.createAnswer()).then(answer => peerConnection.setLocalDescription(answer)).then(() => {\n          socket.emit('answer', {\n            sdp: peerConnection.localDescription,\n            target: data.sender\n          });\n        }).catch(err => console.error(err));\n      }\n    });\n    socket.on('answer', data => {\n      const peerConnection = peerConnectionRef.current;\n      if (peerConnection && !peerConnection.currentRemoteDescription) {\n        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));\n      }\n    });\n    socket.on('candidate', data => {\n      const peerConnection = peerConnectionRef.current;\n      if (peerConnection) {\n        peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));\n      }\n    });\n    return () => {\n      socket.off('offer');\n      socket.off('answer');\n      socket.off('candidate');\n    };\n  }, [localStream]);\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: /*#__PURE__*/_jsxDEV(\"section\", {\n      className: \"w-full h-full flex content-center items-center flex-col bg-cyan-500 mx-[500px] shadow-2xl shadow-black\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex flex-grow content-center items-center min-h-[200px] min-w-[200px] max-h-[200px] max-w-[200px]  mt-10\",\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"w-full h-full flex content-center  bg-anon bg-cover bg-no-repeat rounded-3xl \"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 126,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 125,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex pb-10 hover:transition-all hover:opacity-80 flex-col items-center justify-center\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            getUserId();\n          },\n          className: \"bg-green-300 rounded-3xl text-3xl w-[250px] h-[40px] mb-5 mt-80 text-white\",\n          children: \"\\u041D\\u0430\\u0447\\u0430\\u0442\\u044C \\u043F\\u043E\\u0438\\u0441\\u043A\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 129,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          className: \"text-1xl\",\n          children: \"\\u041A\\u043E\\u043B\\u0438\\u0447\\u0435\\u0441\\u0442\\u0432\\u043E \\u043F\\u043E\\u043B\\u044C\\u0437\\u043E\\u0432\\u0430\\u0442\\u0435\\u043B\\u0435\\u0439 \\u043E\\u043D\\u043B\\u0430\\u0439\\u043D:\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 137,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 128,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 124,\n      columnNumber: 7\n    }, this)\n  }, void 0, false);\n};\n_s(MainPage, \"zSHYFBa7QNHcI3KUeGvvRFJeV50=\");\n_c = MainPage;\nexport default MainPage;\nvar _c;\n$RefreshReg$(_c, \"MainPage\");","map":{"version":3,"names":["React","useEffect","useRef","useState","io","Cookies","jsxDEV","_jsxDEV","Fragment","_Fragment","socket","transports","configuration","iceServers","urls","MainPage","_s","localStream","setLocalStream","peerConnectionRef","getTracks","forEach","track","stop","off","current","close","getUserId","userId","get","alert","emit","getMedia","stream","navigator","mediaDevices","getUserMedia","audio","video","startCall","err","console","error","peerConnection","RTCPeerConnection","addTrack","onicecandidate","event","candidate","log","target","createOffer","then","offer","setLocalDescription","sdp","localDescription","catch","on","data","sender","setRemoteDescription","RTCSessionDescription","createAnswer","answer","currentRemoteDescription","addIceCandidate","RTCIceCandidate","children","className","fileName","_jsxFileName","lineNumber","columnNumber","onClick","_c","$RefreshReg$"],"sources":["/home/goik4/Универ/corsework/Voice-Roulete-Coursework/Voice-Roulete-Coursework/roulete/client/src/routes/MainPage/MainPage.tsx"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\nimport io from 'socket.io-client';\nimport Cookies from 'js-cookie';\n\nconst socket = io('http://localhost:5000', { transports: ['websocket'] });\nconst configuration: RTCConfiguration = {\n  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],\n};\n\nconst MainPage: React.FC = () => {\n  const [localStream, setLocalStream] = useState<MediaStream | null>(null);\n  const peerConnectionRef = useRef<RTCPeerConnection | null>(null);\n\n  useEffect(() => {\n    return () => {\n      localStream?.getTracks().forEach((track) => track.stop());\n      socket.off('offer');\n      socket.off('answer');\n      socket.off('candidate');\n      if (peerConnectionRef.current) {\n        peerConnectionRef.current.close();\n      }\n    };\n  }, [localStream]);\n\n  const getUserId = () => {\n    const userId = Cookies.get('userIdState');\n    if (!userId) {\n      alert('Сначала войдите в аккаунт');\n      return;\n    }\n    socket.emit('auth', userId);\n    getMedia(userId);\n  };\n\n  const getMedia = async (userId: string) => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });\n      setLocalStream(stream);\n      startCall(stream, userId);\n    } catch (err) {\n      console.error('Не удалось получить доступ к микрофону', err);\n    }\n  };\n\n  const startCall = (stream: MediaStream, userId: string) => {\n    // Создаем подключение\n    const peerConnection = new RTCPeerConnection(configuration);\n    peerConnectionRef.current = peerConnection;\n    // Добавляем треки\n    stream.getTracks().forEach((track) => {\n      peerConnection.addTrack(track, stream);\n    });\n\n    // Слушаем кандидатов ICE\n    peerConnection.onicecandidate = (event) => {\n      if (event.candidate) {\n        console.log(event.candidate)\n        socket.emit('candidate', { candidate: event.candidate, target: userId });\n      }\n    };\n\n    // Создаем предложение (offer)\n    peerConnection.createOffer()\n      .then((offer) => peerConnection.setLocalDescription(offer))\n      .then(() => {\n        // Отправляем предложение через сокет\n        socket.emit('offer', { sdp: peerConnection.localDescription, target: userId });\n      })\n      .catch((err) => console.error(err));\n  };\n\n  // Устанавливаем обработчики событий сокета\n  useEffect(() => {\n    socket.on('offer', (data: { sdp: RTCSessionDescriptionInit, sender: string }) => {\n      if (!peerConnectionRef.current && localStream) {\n        const peerConnection = new RTCPeerConnection(configuration);\n        peerConnectionRef.current = peerConnection;\n        \n        localStream.getTracks().forEach((track) => {\n          peerConnection.addTrack(track, localStream);\n        });\n\n        peerConnection.onicecandidate = (event) => {\n          if (event.candidate) {\n            socket.emit('candidate', { candidate: event.candidate, target: data.sender });\n          }\n        };\n\n        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp))\n          .then(() => peerConnection.createAnswer())\n          .then((answer) => peerConnection.setLocalDescription(answer))\n          .then(() => {\n            socket.emit('answer', { sdp: peerConnection.localDescription, target: data.sender });\n          })\n          .catch((err) => console.error(err));\n      }\n    });\n\n    socket.on('answer', (data: { sdp: RTCSessionDescriptionInit }) => {\n      const peerConnection = peerConnectionRef.current;\n      if (peerConnection && !peerConnection.currentRemoteDescription) {\n        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));\n      }\n    });\n\n    socket.on('candidate', (data: { candidate: RTCIceCandidateInit }) => {\n      const peerConnection = peerConnectionRef.current;\n      if (peerConnection) {\n        peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));\n      }\n    });\n\n    return () => {\n      socket.off('offer');\n      socket.off('answer');\n      socket.off('candidate');\n    };\n  }, [localStream]);\n\n\n  return (\n    <>\n      <section className=\"w-full h-full flex content-center items-center flex-col bg-cyan-500 mx-[500px] shadow-2xl shadow-black\">\n        <div className=\"flex flex-grow content-center items-center min-h-[200px] min-w-[200px] max-h-[200px] max-w-[200px]  mt-10\">\n          <div className=\"w-full h-full flex content-center  bg-anon bg-cover bg-no-repeat rounded-3xl \"></div>\n        </div>\n        <div className=\"flex pb-10 hover:transition-all hover:opacity-80 flex-col items-center justify-center\">\n          <button\n            onClick={() => {\n              getUserId()\n            }}\n            className=\"bg-green-300 rounded-3xl text-3xl w-[250px] h-[40px] mb-5 mt-80 text-white\"\n          >\n            Начать поиск\n          </button>\n          <p className=\"text-1xl\">Количество пользователей онлайн:</p>\n        </div>\n      </section>\n    </>\n  );\n}\n\n\nexport default MainPage"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}